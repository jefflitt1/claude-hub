# Session Recap: mac_20260127_1740
**Time:** 2026-01-27 17:40 ET
**Terminal:** mac (MacBook Pro)
**Est. Tokens:** ~120,000

## Completed
- Added short-term memory to Telegram chatbot (`claude-http-server.js`) -- fetches last 6 messages from Supabase `telegram_chat_history` and injects as `<conversation_history>` XML into prompt
- Long messages truncated at 500 chars to prevent Pi OOM crashes
- Updated all 5 bot HTTP request nodes in n8n workflow `stlQoP2huGVmGzRS` to pass `bot_username` and `chat_id`
- Removed redundant n8n-side history injection from `Process Terminal` node (server handles it)
- Cleaned up all 5 `Load History` nodes (replaced broken `fetch()` calls with simple pass-throughs)
- Made `claude-http-server.js` paths portable (`os.homedir()`, auto-detect claude binary)
- Fixed server binding from `127.0.0.1` to `0.0.0.0` (was blocking LAN/Tailscale access from n8n)
- Added `/health` and `/healthz` endpoints (no auth) to fix "Claude Server Unhealthy" alerts
- Updated Mac Studio launchd plist (`com.claude.http-server.plist`) with `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, and `PATH` env vars
- Restarted n8n on Pi after task runner crash (consecutive OOM crashes)
- Verified end-to-end: bot correctly recalled Tavily conversation from history, responded with contextual analysis

## Decisions Made
- Server-side memory injection over n8n-side (more reliable, single point of change, better XML formatting)
- History capped at 6 messages (3 exchanges) -- balances context vs Pi memory/token cost
- Message truncation at 500 chars -- prevents long responses from bloating prompt
- Kept PDF to Supabase workflow active; Google Drive doc extraction deferred until use case clarified

## New Open Items
- PDF to Supabase workflow had a "No error message" crash -- may need investigation if recurring
- Document extraction strategy (RAG vs structured extraction vs Drive auto-process) -- user will decide when use case is clear
- Gemini and Codex CLI auth expired (noted by terminal bot) -- need `gemini` and `codex login` re-auth on Mac Studio

## Notes
- The n8n `Load History` Code nodes were using `fetch()` which is not available in n8n's JavaScript runtime -- they were silently failing the entire time
- LaunchAgent plist on Mac Studio had no env vars, so Supabase was never accessible to the server process
- The 18-minute response time was a one-off from n8n retry queue backlog during server restarts; normal is ~2.5 min
- `telegram_chat_history` table was already populated (14 messages for ClaudeTerminalBot) but never read back -- the infrastructure was half-built

{"updatedAt":"2026-01-26T17:36:37.427Z","createdAt":"2026-01-26T13:59:23.184Z","id":"JaTL7b6ka9mH4MuJ","name":"Self-Healing Monitor","description":null,"active":true,"isArchived":false,"nodes":[{"id":"schedule-trigger","name":"Every 15 Minutes","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,200],"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}}},{"id":"webhook-trigger","name":"Manual Trigger","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,400],"webhookId":"self-heal","parameters":{"httpMethod":"POST","path":"self-heal","responseMode":"lastNode","options":{}}},{"id":"check-claude-server","name":"Check Claude Server","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[250,150],"continueOnFail":true,"parameters":{"method":"GET","url":"http://192.168.5.38:3847/health","options":{"timeout":10000}}},{"id":"check-docker","name":"Check Docker API","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[250,300],"continueOnFail":true,"parameters":{"method":"GET","url":"http://192.168.5.38:2375/version","options":{"timeout":5000}}},{"id":"check-n8n-self","name":"Check n8n Health","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[250,450],"continueOnFail":true,"parameters":{"method":"GET","url":"https://n8n.l7-partners.com/healthz","options":{"timeout":5000}}},{"id":"merge-health","name":"Merge Health Checks","type":"n8n-nodes-base.merge","typeVersion":3,"position":[500,300],"parameters":{"mode":"append"}},{"id":"check-cooldown","name":"Check Cooldown","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[700,300],"continueOnFail":true,"parameters":{"method":"GET","url":"https://donnmhbwhpjlmpnwgdqr.supabase.co/rest/v1/system_health_checks?check_name=eq.self_healing_remediation&order=checked_at.desc&limit=1","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Authorization","value":"Bearer sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"}]},"options":{"timeout":5000}}},{"id":"fetch-history","name":"Fetch Recent Issues","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[700,450],"continueOnFail":true,"parameters":{"method":"GET","url":"https://donnmhbwhpjlmpnwgdqr.supabase.co/rest/v1/system_health_checks?check_name=eq.self_healing_monitor&status=neq.healthy&order=checked_at.desc&limit=10","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Authorization","value":"Bearer sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"}]},"options":{"timeout":5000}}},{"id":"analyze-all","name":"Analyze Health & Decide","type":"n8n-nodes-base.code","typeVersion":2,"position":[950,300],"parameters":{"jsCode":"// ============================================\n// SELF-HEALING MONITOR - COMPREHENSIVE ANALYSIS\n// Features: Multi-endpoint, Cooldown, Known Issues, History\n// ============================================\n\nconst now = new Date();\nconst COOLDOWN_MINUTES = 30;\n\n// Known issue patterns (fast-path before AI)\nconst KNOWN_ISSUES = [\n  { pattern: /disk.*9[0-9]%/i, name: 'Disk Full', command: 'docker system prune -af', cooldown: 60 },\n  { pattern: /memory.*high/i, name: 'High Memory', command: 'sudo systemctl restart claude-http-server', cooldown: 30 },\n  { pattern: /connection.*refused/i, name: 'Connection Refused', command: 'sudo systemctl restart docker', cooldown: 15 },\n  { pattern: /ECONNREFUSED/i, name: 'Service Down', command: 'systemctl status claude-http-server docker', cooldown: 5 },\n  { pattern: /timeout/i, name: 'Timeout', command: 'ping -c 3 8.8.8.8', cooldown: 5 },\n  { pattern: /no space left/i, name: 'No Space', command: 'sudo rm -rf /tmp/*; docker system prune -f', cooldown: 60 },\n];\n\n// Get all inputs\nconst allItems = $input.all();\nconst claudeHealth = allItems[0]?.json || {};\nconst dockerHealth = allItems[1]?.json || {};\nconst n8nHealth = allItems[2]?.json || {};\nconst cooldownData = allItems[3]?.json || [];\nconst historyData = allItems[4]?.json || [];\n\n// Parse health check results\nfunction parseHealthCheck(response, serviceName) {\n  const hasError = response.error || response.code || (response.statusCode && response.statusCode >= 400);\n  const isHealthy = !hasError && (response.status === 'ok' || response.Version || response.statusCode === 200);\n  return {\n    service: serviceName,\n    healthy: isHealthy,\n    reachable: !hasError,\n    response: response,\n    error: hasError ? (response.message || response.error || 'Unknown error') : null\n  };\n}\n\nconst services = {\n  claude: parseHealthCheck(claudeHealth, 'claude-server'),\n  docker: parseHealthCheck(dockerHealth, 'docker'),\n  n8n: parseHealthCheck(n8nHealth, 'n8n')\n};\n\n// Overall status\nconst allHealthy = Object.values(services).every(s => s.healthy);\nconst anyUnreachable = Object.values(services).some(s => !s.reachable);\nconst issues = Object.values(services).filter(s => !s.healthy).map(s => s.error || s.service + ' unhealthy');\n\n// Check cooldown\nconst lastRemediation = Array.isArray(cooldownData) && cooldownData.length > 0 ? cooldownData[0] : null;\nconst lastRemediationTime = lastRemediation ? new Date(lastRemediation.checked_at) : null;\nconst cooldownActive = lastRemediationTime && ((now - lastRemediationTime) < COOLDOWN_MINUTES * 60 * 1000);\nconst cooldownRemaining = cooldownActive ? Math.ceil((COOLDOWN_MINUTES * 60 * 1000 - (now - lastRemediationTime)) / 60000) : 0;\n\n// Check for known issue match\nlet knownIssueMatch = null;\nconst issueText = issues.join(' ');\nfor (const ki of KNOWN_ISSUES) {\n  if (ki.pattern.test(issueText)) {\n    knownIssueMatch = ki;\n    break;\n  }\n}\n\n// Build historical context\nconst recentIssues = Array.isArray(historyData) ? historyData : [];\nconst historySummary = recentIssues.slice(0, 5).map(h => \n  `- ${new Date(h.checked_at).toISOString().slice(0,16)}: ${h.error_message || h.status}`\n).join('\\n');\n\n// Determine action\nlet action = 'healthy';\nlet actionReason = 'All services healthy';\n\nif (!allHealthy) {\n  if (anyUnreachable && !services.claude.reachable) {\n    action = 'alert_only';\n    actionReason = 'Mac Studio unreachable - cannot auto-remediate';\n  } else if (cooldownActive) {\n    action = 'cooldown_wait';\n    actionReason = `Cooldown active (${cooldownRemaining} min remaining)`;\n  } else if (knownIssueMatch) {\n    action = 'run_runbook';\n    actionReason = `Known issue: ${knownIssueMatch.name}`;\n  } else {\n    action = 'investigate';\n    actionReason = 'Unknown issue - sending to AI';\n  }\n}\n\n// Create issue signature for deduplication\nconst issueSignature = issues.length > 0 ? \n  require('crypto').createHash('md5').update(issues.sort().join('|')).digest('hex').slice(0, 8) : \n  'healthy';\n\nreturn [{\n  json: {\n    timestamp: now.toISOString(),\n    services: services,\n    all_healthy: allHealthy,\n    any_unreachable: anyUnreachable,\n    issues: issues,\n    issue_signature: issueSignature,\n    cooldown: {\n      active: cooldownActive,\n      remaining_mins: cooldownRemaining,\n      last_remediation: lastRemediationTime?.toISOString()\n    },\n    known_issue: knownIssueMatch ? {\n      name: knownIssueMatch.name,\n      command: knownIssueMatch.command,\n      cooldown: knownIssueMatch.cooldown\n    } : null,\n    history: {\n      recent_issues_count: recentIssues.length,\n      summary: historySummary || 'No recent issues'\n    },\n    action: action,\n    action_reason: actionReason\n  }\n}];"}},{"id":"route-action","name":"Route by Action","type":"n8n-nodes-base.switch","typeVersion":2,"position":[1200,300],"parameters":{"dataType":"string","value1":"={{ $json.action }}","rules":{"rules":[{"value2":"investigate"},{"value2":"run_runbook"},{"value2":"alert_only"},{"value2":"cooldown_wait"},{"value2":"healthy"}]}}},{"id":"build-ai-prompt","name":"Build AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[1450,100],"parameters":{"jsCode":"const data = $input.first().json;\n\nconst serviceStatus = Object.entries(data.services).map(function(entry) {\n  const name = entry[0];\n  const s = entry[1];\n  return '- ' + name + ': ' + (s.healthy ? 'HEALTHY' : 'UNHEALTHY') + (s.error ? ' (' + s.error + ')' : '');\n}).join('\\n');\n\nconst issuesList = data.issues.map(function(i) { return '- ' + i; }).join('\\n') || 'None';\n\nconst prompt = 'AUTOMATED SELF-HEALING INVESTIGATION\\n\\n' +\n  'ISSUE SIGNATURE: ' + data.issue_signature + '\\n' +\n  'TIMESTAMP: ' + data.timestamp + '\\n\\n' +\n  'SERVICES STATUS:\\n' + serviceStatus + '\\n\\n' +\n  'ISSUES DETECTED:\\n' + issuesList + '\\n\\n' +\n  'RECENT HISTORY:\\n' + data.history.summary + '\\n\\n' +\n  'INSTRUCTIONS:\\n' +\n  '1. Diagnose the root cause\\n' +\n  '2. Check relevant logs\\n' +\n  '3. Attempt safe remediation if confident\\n' +\n  '4. Report findings clearly\\n\\n' +\n  'Be concise but thorough.';\n\nreturn [{\n  json: {\n    prompt: prompt,\n    working_dir: '/Users/jgl',\n    dangerous_mode: true,\n    session_id: 'self-heal-' + data.issue_signature + '-' + Date.now(),\n    context: data\n  }\n}];"}},{"id":"call-claude","name":"Send to Claude Code","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1700,100],"continueOnFail":true,"parameters":{"method":"POST","url":"http://192.168.5.38:3847/claude","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ prompt: $json.prompt, working_dir: $json.working_dir, dangerous_mode: $json.dangerous_mode, session_id: $json.session_id }) }}","options":{"timeout":300000}}},{"id":"parse-ai-response","name":"Parse AI Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1950,100],"parameters":{"jsCode":"const claudeResult = $input.first().json;\nconst buildData = $('Build AI Prompt').item.json;\n\nconst success = claudeResult.success || false;\nconst output = claudeResult.output || claudeResult.error || 'No response';\nconst truncated = output.length > 2500 ? output.substring(0, 2500) + '\\n[Truncated...]' : output;\n\nreturn [{\n  json: {\n    remediation_type: 'ai_investigation',\n    success: success,\n    response: output,\n    truncated_response: truncated,\n    issue_signature: buildData.context.issue_signature,\n    original_issues: buildData.context.issues,\n    timestamp: buildData.context.timestamp\n  }\n}];"}},{"id":"build-runbook-prompt","name":"Build Runbook Command","type":"n8n-nodes-base.code","typeVersion":2,"position":[1450,250],"parameters":{"jsCode":"const data = $input.first().json;\nconst ki = data.known_issue;\n\nconst prompt = \\`AUTOMATED RUNBOOK EXECUTION\n\nKnown Issue Detected: \\${ki.name}\nCommand to Execute: \\${ki.command}\n\nPlease execute this command and report the output.\nThis is a known issue with a predefined fix.\\`;\n\nreturn [{\n  json: {\n    prompt: prompt,\n    working_dir: '/Users/jgl',\n    dangerous_mode: true,\n    session_id: 'runbook-' + data.issue_signature + '-' + Date.now(),\n    runbook_name: ki.name,\n    runbook_command: ki.command,\n    context: data\n  }\n}];"}},{"id":"execute-runbook","name":"Execute Runbook","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1700,250],"continueOnFail":true,"parameters":{"method":"POST","url":"http://192.168.5.38:3847/claude","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ prompt: $json.prompt, working_dir: $json.working_dir, dangerous_mode: $json.dangerous_mode, session_id: $json.session_id }) }}","options":{"timeout":120000}}},{"id":"parse-runbook-response","name":"Parse Runbook Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1950,250],"parameters":{"jsCode":"const result = $input.first().json;\nconst buildData = $('Build Runbook Command').item.json;\n\nconst success = result.success || false;\nconst output = result.output || result.error || 'No response';\nconst truncated = output.length > 2000 ? output.substring(0, 2000) + '\\n[Truncated...]' : output;\n\nreturn [{\n  json: {\n    remediation_type: 'runbook',\n    runbook_name: buildData.runbook_name,\n    success: success,\n    response: output,\n    truncated_response: truncated,\n    issue_signature: buildData.context.issue_signature,\n    original_issues: buildData.context.issues,\n    timestamp: buildData.context.timestamp\n  }\n}];"}},{"id":"alert-unreachable","name":"Alert Unreachable","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1450,400],"parameters":{"method":"POST","url":"https://api.telegram.org/bot8169830247:AAF_BStYa7AqKPbHCeErAl2oij17d7cJhyI/sendMessage","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  chat_id: 7938188628,\n  text: 'ðŸ”´ *Mac Studio Unreachable*\\n\\nSelf-healing cannot proceed.\\n\\n*Issues:*\\n' + $json.issues.map(i => 'â€¢ ' + i).join('\\n') + '\\n\\n*Services:*\\n' + Object.entries($json.services).map(([n,s]) => 'â€¢ ' + n + ': ' + (s.healthy ? 'âœ…' : 'âŒ')).join('\\n') + '\\n\\n_Manual intervention required._',\n  parse_mode: 'Markdown'\n}) }}","options":{}}},{"id":"log-cooldown","name":"Log Cooldown Skip","type":"n8n-nodes-base.code","typeVersion":2,"position":[1450,550],"parameters":{"jsCode":"const data = $input.first().json;\nreturn [{\n  json: {\n    log_type: 'cooldown_skip',\n    message: 'Remediation skipped - cooldown active',\n    cooldown_remaining: data.cooldown.remaining_mins,\n    issues: data.issues,\n    timestamp: data.timestamp\n  }\n}];"}},{"id":"healthy-noop","name":"All Healthy","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1450,700],"parameters":{}},{"id":"merge-results","name":"Merge Results","type":"n8n-nodes-base.merge","typeVersion":3,"position":[2200,300],"parameters":{"mode":"append"}},{"id":"notify-result","name":"Notify Result","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2450,200],"parameters":{"method":"POST","url":"https://api.telegram.org/bot8169830247:AAF_BStYa7AqKPbHCeErAl2oij17d7cJhyI/sendMessage","sendBody":true,"specifyBody":"json","jsonBody":"={{ (() => {\n  const type = $json.remediation_type || 'unknown';\n  const runbook = $json.runbook_name || '';\n  const success = $json.success === true;\n  const issues = Array.isArray($json.original_issues) ? $json.original_issues : [];\n  const response = ($json.truncated_response || 'N/A').substring(0, 1500);\n  \n  let text = 'ðŸ”§ Self-Healing Report\\n\\n';\n  text += 'Type: ' + type + '\\n';\n  if (runbook) text += 'Runbook: ' + runbook + '\\n';\n  text += 'Result: ' + (success ? 'âœ… Success' : 'âŒ Failed') + '\\n\\n';\n  text += 'Issues:\\n' + issues.map(i => 'â€¢ ' + i).join('\\n') + '\\n\\n';\n  text += 'Response:\\n' + response;\n  \n  return JSON.stringify({\n    chat_id: 7938188628,\n    text: text\n  });\n})() }}","options":{}}},{"id":"log-remediation","name":"Log Remediation","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2450,400],"parameters":{"method":"POST","url":"https://donnmhbwhpjlmpnwgdqr.supabase.co/rest/v1/system_health_checks","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Authorization","value":"Bearer sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  check_name: 'self_healing_remediation',\n  service: $json.remediation_type || 'unknown',\n  status: $json.success ? 'success' : 'failed',\n  error_message: ($json.issue_signature || '') + ' | ' + ($json.original_issues || []).join('; ')\n}) }}","options":{}}},{"id":"log-health","name":"Log Health Check","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2700,500],"parameters":{"method":"POST","url":"https://donnmhbwhpjlmpnwgdqr.supabase.co/rest/v1/system_health_checks","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Authorization","value":"Bearer sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  check_name: 'self_healing_monitor',\n  service: 'all_services',\n  status: $('Analyze Health & Decide').item.json.all_healthy ? 'healthy' : 'degraded',\n  error_message: $('Analyze Health & Decide').item.json.issues.join('; ') || null\n}) }}","options":{}}}],"connections":{"Every 15 Minutes":{"main":[[{"node":"Check Claude Server","type":"main","index":0},{"node":"Check Docker API","type":"main","index":0},{"node":"Check n8n Health","type":"main","index":0}]]},"Manual Trigger":{"main":[[{"node":"Check Claude Server","type":"main","index":0},{"node":"Check Docker API","type":"main","index":0},{"node":"Check n8n Health","type":"main","index":0}]]},"Check Claude Server":{"main":[[{"node":"Merge Health Checks","type":"main","index":0}]]},"Check Docker API":{"main":[[{"node":"Merge Health Checks","type":"main","index":1}]]},"Check n8n Health":{"main":[[{"node":"Merge Health Checks","type":"main","index":2}]]},"Merge Health Checks":{"main":[[{"node":"Check Cooldown","type":"main","index":0},{"node":"Fetch Recent Issues","type":"main","index":0}]]},"Check Cooldown":{"main":[[{"node":"Analyze Health & Decide","type":"main","index":0}]]},"Fetch Recent Issues":{"main":[[{"node":"Analyze Health & Decide","type":"main","index":0}]]},"Analyze Health & Decide":{"main":[[{"node":"Route by Action","type":"main","index":0}]]},"Route by Action":{"main":[[{"node":"Build AI Prompt","type":"main","index":0}],[{"node":"Build Runbook Command","type":"main","index":0}],[{"node":"Alert Unreachable","type":"main","index":0}],[{"node":"Log Cooldown Skip","type":"main","index":0}],[{"node":"All Healthy","type":"main","index":0}]]},"Build AI Prompt":{"main":[[{"node":"Send to Claude Code","type":"main","index":0}]]},"Send to Claude Code":{"main":[[{"node":"Parse AI Response","type":"main","index":0}]]},"Parse AI Response":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Build Runbook Command":{"main":[[{"node":"Execute Runbook","type":"main","index":0}]]},"Execute Runbook":{"main":[[{"node":"Parse Runbook Response","type":"main","index":0}]]},"Parse Runbook Response":{"main":[[{"node":"Merge Results","type":"main","index":1}]]},"Alert Unreachable":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]},"Log Cooldown Skip":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]},"All Healthy":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]},"Merge Results":{"main":[[{"node":"Notify Result","type":"main","index":0},{"node":"Log Remediation","type":"main","index":0}]]},"Notify Result":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]},"Log Remediation":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","errorWorkflow":"OSKEDUq7HqOKiwWw","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{"node:Every 15 Minutes":{"recurrenceRules":[]}},"meta":null,"pinData":null,"versionId":"e791a888-28f2-4385-a311-c28645fc81cc","activeVersionId":"e791a888-28f2-4385-a311-c28645fc81cc","versionCounter":51,"triggerCount":2,"shared":[{"updatedAt":"2026-01-26T13:59:23.192Z","createdAt":"2026-01-26T13:59:23.192Z","role":"workflow:owner","workflowId":"JaTL7b6ka9mH4MuJ","projectId":"lmS9m7rMVNiAe0a3","project":{"updatedAt":"2025-07-25T14:19:26.646Z","createdAt":"2025-07-25T13:32:57.291Z","id":"lmS9m7rMVNiAe0a3","name":"Jeff Littell <jglittell@gmail.com>","type":"personal","icon":null,"description":null,"creatorId":"baafff79-4b16-4de2-a858-2c72a40fe7db","projectRelations":[{"updatedAt":"2025-07-25T13:32:57.291Z","createdAt":"2025-07-25T13:32:57.291Z","userId":"baafff79-4b16-4de2-a858-2c72a40fe7db","projectId":"lmS9m7rMVNiAe0a3","user":{"updatedAt":"2026-01-26T05:00:28.000Z","createdAt":"2025-07-25T13:32:56.598Z","id":"baafff79-4b16-4de2-a858-2c72a40fe7db","email":"jglittell@gmail.com","firstName":"Jeff","lastName":"Littell","personalizationAnswers":{"version":"v4","personalization_survey_submitted_at":"2025-07-25T14:19:50.681Z","personalization_survey_n8n_version":"1.103.2","companyIndustryExtended":["other"],"otherCompanyIndustryExtended":"Real Estate","companySize":"<20","companyType":"other","role":"business-owner","reportedSource":"youtube"},"settings":{"userActivated":true,"easyAIWorkflowOnboarded":true,"firstSuccessfulWorkflowId":"nDfMeiaDA9efzeUS","userActivatedAt":1754712040092,"npsSurvey":{"responded":true,"lastShownAt":1757030752517},"defaultProjectId":"lmS9m7rMVNiAe0a3"},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-01-26","isPending":false}},{"updatedAt":null,"createdAt":null,"userId":"1000","projectId":"lmS9m7rMVNiAe0a3","user":null}]}}],"tags":[],"activeVersion":{"updatedAt":"2026-01-26T17:36:37.430Z","createdAt":"2026-01-26T17:36:37.430Z","versionId":"e791a888-28f2-4385-a311-c28645fc81cc","workflowId":"JaTL7b6ka9mH4MuJ","nodes":[{"id":"schedule-trigger","name":"Every 15 Minutes","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,200],"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":15}]}}},{"id":"webhook-trigger","name":"Manual Trigger","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,400],"webhookId":"self-heal","parameters":{"httpMethod":"POST","path":"self-heal","responseMode":"lastNode","options":{}}},{"id":"check-claude-server","name":"Check Claude Server","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[250,150],"continueOnFail":true,"parameters":{"method":"GET","url":"http://192.168.5.38:3847/health","options":{"timeout":10000}}},{"id":"check-docker","name":"Check Docker API","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[250,300],"continueOnFail":true,"parameters":{"method":"GET","url":"http://192.168.5.38:2375/version","options":{"timeout":5000}}},{"id":"check-n8n-self","name":"Check n8n Health","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[250,450],"continueOnFail":true,"parameters":{"method":"GET","url":"https://n8n.l7-partners.com/healthz","options":{"timeout":5000}}},{"id":"merge-health","name":"Merge Health Checks","type":"n8n-nodes-base.merge","typeVersion":3,"position":[500,300],"parameters":{"mode":"append"}},{"id":"check-cooldown","name":"Check Cooldown","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[700,300],"continueOnFail":true,"parameters":{"method":"GET","url":"https://donnmhbwhpjlmpnwgdqr.supabase.co/rest/v1/system_health_checks?check_name=eq.self_healing_remediation&order=checked_at.desc&limit=1","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Authorization","value":"Bearer sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"}]},"options":{"timeout":5000}}},{"id":"fetch-history","name":"Fetch Recent Issues","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[700,450],"continueOnFail":true,"parameters":{"method":"GET","url":"https://donnmhbwhpjlmpnwgdqr.supabase.co/rest/v1/system_health_checks?check_name=eq.self_healing_monitor&status=neq.healthy&order=checked_at.desc&limit=10","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Authorization","value":"Bearer sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"}]},"options":{"timeout":5000}}},{"id":"analyze-all","name":"Analyze Health & Decide","type":"n8n-nodes-base.code","typeVersion":2,"position":[950,300],"parameters":{"jsCode":"// ============================================\n// SELF-HEALING MONITOR - COMPREHENSIVE ANALYSIS\n// Features: Multi-endpoint, Cooldown, Known Issues, History\n// ============================================\n\nconst now = new Date();\nconst COOLDOWN_MINUTES = 30;\n\n// Known issue patterns (fast-path before AI)\nconst KNOWN_ISSUES = [\n  { pattern: /disk.*9[0-9]%/i, name: 'Disk Full', command: 'docker system prune -af', cooldown: 60 },\n  { pattern: /memory.*high/i, name: 'High Memory', command: 'sudo systemctl restart claude-http-server', cooldown: 30 },\n  { pattern: /connection.*refused/i, name: 'Connection Refused', command: 'sudo systemctl restart docker', cooldown: 15 },\n  { pattern: /ECONNREFUSED/i, name: 'Service Down', command: 'systemctl status claude-http-server docker', cooldown: 5 },\n  { pattern: /timeout/i, name: 'Timeout', command: 'ping -c 3 8.8.8.8', cooldown: 5 },\n  { pattern: /no space left/i, name: 'No Space', command: 'sudo rm -rf /tmp/*; docker system prune -f', cooldown: 60 },\n];\n\n// Get all inputs\nconst allItems = $input.all();\nconst claudeHealth = allItems[0]?.json || {};\nconst dockerHealth = allItems[1]?.json || {};\nconst n8nHealth = allItems[2]?.json || {};\nconst cooldownData = allItems[3]?.json || [];\nconst historyData = allItems[4]?.json || [];\n\n// Parse health check results\nfunction parseHealthCheck(response, serviceName) {\n  const hasError = response.error || response.code || (response.statusCode && response.statusCode >= 400);\n  const isHealthy = !hasError && (response.status === 'ok' || response.Version || response.statusCode === 200);\n  return {\n    service: serviceName,\n    healthy: isHealthy,\n    reachable: !hasError,\n    response: response,\n    error: hasError ? (response.message || response.error || 'Unknown error') : null\n  };\n}\n\nconst services = {\n  claude: parseHealthCheck(claudeHealth, 'claude-server'),\n  docker: parseHealthCheck(dockerHealth, 'docker'),\n  n8n: parseHealthCheck(n8nHealth, 'n8n')\n};\n\n// Overall status\nconst allHealthy = Object.values(services).every(s => s.healthy);\nconst anyUnreachable = Object.values(services).some(s => !s.reachable);\nconst issues = Object.values(services).filter(s => !s.healthy).map(s => s.error || s.service + ' unhealthy');\n\n// Check cooldown\nconst lastRemediation = Array.isArray(cooldownData) && cooldownData.length > 0 ? cooldownData[0] : null;\nconst lastRemediationTime = lastRemediation ? new Date(lastRemediation.checked_at) : null;\nconst cooldownActive = lastRemediationTime && ((now - lastRemediationTime) < COOLDOWN_MINUTES * 60 * 1000);\nconst cooldownRemaining = cooldownActive ? Math.ceil((COOLDOWN_MINUTES * 60 * 1000 - (now - lastRemediationTime)) / 60000) : 0;\n\n// Check for known issue match\nlet knownIssueMatch = null;\nconst issueText = issues.join(' ');\nfor (const ki of KNOWN_ISSUES) {\n  if (ki.pattern.test(issueText)) {\n    knownIssueMatch = ki;\n    break;\n  }\n}\n\n// Build historical context\nconst recentIssues = Array.isArray(historyData) ? historyData : [];\nconst historySummary = recentIssues.slice(0, 5).map(h => \n  `- ${new Date(h.checked_at).toISOString().slice(0,16)}: ${h.error_message || h.status}`\n).join('\\n');\n\n// Determine action\nlet action = 'healthy';\nlet actionReason = 'All services healthy';\n\nif (!allHealthy) {\n  if (anyUnreachable && !services.claude.reachable) {\n    action = 'alert_only';\n    actionReason = 'Mac Studio unreachable - cannot auto-remediate';\n  } else if (cooldownActive) {\n    action = 'cooldown_wait';\n    actionReason = `Cooldown active (${cooldownRemaining} min remaining)`;\n  } else if (knownIssueMatch) {\n    action = 'run_runbook';\n    actionReason = `Known issue: ${knownIssueMatch.name}`;\n  } else {\n    action = 'investigate';\n    actionReason = 'Unknown issue - sending to AI';\n  }\n}\n\n// Create issue signature for deduplication\nconst issueSignature = issues.length > 0 ? \n  require('crypto').createHash('md5').update(issues.sort().join('|')).digest('hex').slice(0, 8) : \n  'healthy';\n\nreturn [{\n  json: {\n    timestamp: now.toISOString(),\n    services: services,\n    all_healthy: allHealthy,\n    any_unreachable: anyUnreachable,\n    issues: issues,\n    issue_signature: issueSignature,\n    cooldown: {\n      active: cooldownActive,\n      remaining_mins: cooldownRemaining,\n      last_remediation: lastRemediationTime?.toISOString()\n    },\n    known_issue: knownIssueMatch ? {\n      name: knownIssueMatch.name,\n      command: knownIssueMatch.command,\n      cooldown: knownIssueMatch.cooldown\n    } : null,\n    history: {\n      recent_issues_count: recentIssues.length,\n      summary: historySummary || 'No recent issues'\n    },\n    action: action,\n    action_reason: actionReason\n  }\n}];"}},{"id":"route-action","name":"Route by Action","type":"n8n-nodes-base.switch","typeVersion":2,"position":[1200,300],"parameters":{"dataType":"string","value1":"={{ $json.action }}","rules":{"rules":[{"value2":"investigate"},{"value2":"run_runbook"},{"value2":"alert_only"},{"value2":"cooldown_wait"},{"value2":"healthy"}]}}},{"id":"build-ai-prompt","name":"Build AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[1450,100],"parameters":{"jsCode":"const data = $input.first().json;\n\nconst serviceStatus = Object.entries(data.services).map(function(entry) {\n  const name = entry[0];\n  const s = entry[1];\n  return '- ' + name + ': ' + (s.healthy ? 'HEALTHY' : 'UNHEALTHY') + (s.error ? ' (' + s.error + ')' : '');\n}).join('\\n');\n\nconst issuesList = data.issues.map(function(i) { return '- ' + i; }).join('\\n') || 'None';\n\nconst prompt = 'AUTOMATED SELF-HEALING INVESTIGATION\\n\\n' +\n  'ISSUE SIGNATURE: ' + data.issue_signature + '\\n' +\n  'TIMESTAMP: ' + data.timestamp + '\\n\\n' +\n  'SERVICES STATUS:\\n' + serviceStatus + '\\n\\n' +\n  'ISSUES DETECTED:\\n' + issuesList + '\\n\\n' +\n  'RECENT HISTORY:\\n' + data.history.summary + '\\n\\n' +\n  'INSTRUCTIONS:\\n' +\n  '1. Diagnose the root cause\\n' +\n  '2. Check relevant logs\\n' +\n  '3. Attempt safe remediation if confident\\n' +\n  '4. Report findings clearly\\n\\n' +\n  'Be concise but thorough.';\n\nreturn [{\n  json: {\n    prompt: prompt,\n    working_dir: '/Users/jgl',\n    dangerous_mode: true,\n    session_id: 'self-heal-' + data.issue_signature + '-' + Date.now(),\n    context: data\n  }\n}];"}},{"id":"call-claude","name":"Send to Claude Code","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1700,100],"continueOnFail":true,"parameters":{"method":"POST","url":"http://192.168.5.38:3847/claude","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ prompt: $json.prompt, working_dir: $json.working_dir, dangerous_mode: $json.dangerous_mode, session_id: $json.session_id }) }}","options":{"timeout":300000}}},{"id":"parse-ai-response","name":"Parse AI Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1950,100],"parameters":{"jsCode":"const claudeResult = $input.first().json;\nconst buildData = $('Build AI Prompt').item.json;\n\nconst success = claudeResult.success || false;\nconst output = claudeResult.output || claudeResult.error || 'No response';\nconst truncated = output.length > 2500 ? output.substring(0, 2500) + '\\n[Truncated...]' : output;\n\nreturn [{\n  json: {\n    remediation_type: 'ai_investigation',\n    success: success,\n    response: output,\n    truncated_response: truncated,\n    issue_signature: buildData.context.issue_signature,\n    original_issues: buildData.context.issues,\n    timestamp: buildData.context.timestamp\n  }\n}];"}},{"id":"build-runbook-prompt","name":"Build Runbook Command","type":"n8n-nodes-base.code","typeVersion":2,"position":[1450,250],"parameters":{"jsCode":"const data = $input.first().json;\nconst ki = data.known_issue;\n\nconst prompt = \\`AUTOMATED RUNBOOK EXECUTION\n\nKnown Issue Detected: \\${ki.name}\nCommand to Execute: \\${ki.command}\n\nPlease execute this command and report the output.\nThis is a known issue with a predefined fix.\\`;\n\nreturn [{\n  json: {\n    prompt: prompt,\n    working_dir: '/Users/jgl',\n    dangerous_mode: true,\n    session_id: 'runbook-' + data.issue_signature + '-' + Date.now(),\n    runbook_name: ki.name,\n    runbook_command: ki.command,\n    context: data\n  }\n}];"}},{"id":"execute-runbook","name":"Execute Runbook","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1700,250],"continueOnFail":true,"parameters":{"method":"POST","url":"http://192.168.5.38:3847/claude","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ prompt: $json.prompt, working_dir: $json.working_dir, dangerous_mode: $json.dangerous_mode, session_id: $json.session_id }) }}","options":{"timeout":120000}}},{"id":"parse-runbook-response","name":"Parse Runbook Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1950,250],"parameters":{"jsCode":"const result = $input.first().json;\nconst buildData = $('Build Runbook Command').item.json;\n\nconst success = result.success || false;\nconst output = result.output || result.error || 'No response';\nconst truncated = output.length > 2000 ? output.substring(0, 2000) + '\\n[Truncated...]' : output;\n\nreturn [{\n  json: {\n    remediation_type: 'runbook',\n    runbook_name: buildData.runbook_name,\n    success: success,\n    response: output,\n    truncated_response: truncated,\n    issue_signature: buildData.context.issue_signature,\n    original_issues: buildData.context.issues,\n    timestamp: buildData.context.timestamp\n  }\n}];"}},{"id":"alert-unreachable","name":"Alert Unreachable","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1450,400],"parameters":{"method":"POST","url":"https://api.telegram.org/bot8169830247:AAF_BStYa7AqKPbHCeErAl2oij17d7cJhyI/sendMessage","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  chat_id: 7938188628,\n  text: 'ðŸ”´ *Mac Studio Unreachable*\\n\\nSelf-healing cannot proceed.\\n\\n*Issues:*\\n' + $json.issues.map(i => 'â€¢ ' + i).join('\\n') + '\\n\\n*Services:*\\n' + Object.entries($json.services).map(([n,s]) => 'â€¢ ' + n + ': ' + (s.healthy ? 'âœ…' : 'âŒ')).join('\\n') + '\\n\\n_Manual intervention required._',\n  parse_mode: 'Markdown'\n}) }}","options":{}}},{"id":"log-cooldown","name":"Log Cooldown Skip","type":"n8n-nodes-base.code","typeVersion":2,"position":[1450,550],"parameters":{"jsCode":"const data = $input.first().json;\nreturn [{\n  json: {\n    log_type: 'cooldown_skip',\n    message: 'Remediation skipped - cooldown active',\n    cooldown_remaining: data.cooldown.remaining_mins,\n    issues: data.issues,\n    timestamp: data.timestamp\n  }\n}];"}},{"id":"healthy-noop","name":"All Healthy","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1450,700],"parameters":{}},{"id":"merge-results","name":"Merge Results","type":"n8n-nodes-base.merge","typeVersion":3,"position":[2200,300],"parameters":{"mode":"append"}},{"id":"notify-result","name":"Notify Result","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2450,200],"parameters":{"method":"POST","url":"https://api.telegram.org/bot8169830247:AAF_BStYa7AqKPbHCeErAl2oij17d7cJhyI/sendMessage","sendBody":true,"specifyBody":"json","jsonBody":"={{ (() => {\n  const type = $json.remediation_type || 'unknown';\n  const runbook = $json.runbook_name || '';\n  const success = $json.success === true;\n  const issues = Array.isArray($json.original_issues) ? $json.original_issues : [];\n  const response = ($json.truncated_response || 'N/A').substring(0, 1500);\n  \n  let text = 'ðŸ”§ Self-Healing Report\\n\\n';\n  text += 'Type: ' + type + '\\n';\n  if (runbook) text += 'Runbook: ' + runbook + '\\n';\n  text += 'Result: ' + (success ? 'âœ… Success' : 'âŒ Failed') + '\\n\\n';\n  text += 'Issues:\\n' + issues.map(i => 'â€¢ ' + i).join('\\n') + '\\n\\n';\n  text += 'Response:\\n' + response;\n  \n  return JSON.stringify({\n    chat_id: 7938188628,\n    text: text\n  });\n})() }}","options":{}}},{"id":"log-remediation","name":"Log Remediation","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2450,400],"parameters":{"method":"POST","url":"https://donnmhbwhpjlmpnwgdqr.supabase.co/rest/v1/system_health_checks","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Authorization","value":"Bearer sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  check_name: 'self_healing_remediation',\n  service: $json.remediation_type || 'unknown',\n  status: $json.success ? 'success' : 'failed',\n  error_message: ($json.issue_signature || '') + ' | ' + ($json.original_issues || []).join('; ')\n}) }}","options":{}}},{"id":"log-health","name":"Log Health Check","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2700,500],"parameters":{"method":"POST","url":"https://donnmhbwhpjlmpnwgdqr.supabase.co/rest/v1/system_health_checks","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Authorization","value":"Bearer sb_secret_ZXJmD3Qb0RqaoXgit5yURw_sxfj16r4"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  check_name: 'self_healing_monitor',\n  service: 'all_services',\n  status: $('Analyze Health & Decide').item.json.all_healthy ? 'healthy' : 'degraded',\n  error_message: $('Analyze Health & Decide').item.json.issues.join('; ') || null\n}) }}","options":{}}}],"connections":{"Every 15 Minutes":{"main":[[{"node":"Check Claude Server","type":"main","index":0},{"node":"Check Docker API","type":"main","index":0},{"node":"Check n8n Health","type":"main","index":0}]]},"Manual Trigger":{"main":[[{"node":"Check Claude Server","type":"main","index":0},{"node":"Check Docker API","type":"main","index":0},{"node":"Check n8n Health","type":"main","index":0}]]},"Check Claude Server":{"main":[[{"node":"Merge Health Checks","type":"main","index":0}]]},"Check Docker API":{"main":[[{"node":"Merge Health Checks","type":"main","index":1}]]},"Check n8n Health":{"main":[[{"node":"Merge Health Checks","type":"main","index":2}]]},"Merge Health Checks":{"main":[[{"node":"Check Cooldown","type":"main","index":0},{"node":"Fetch Recent Issues","type":"main","index":0}]]},"Check Cooldown":{"main":[[{"node":"Analyze Health & Decide","type":"main","index":0}]]},"Fetch Recent Issues":{"main":[[{"node":"Analyze Health & Decide","type":"main","index":0}]]},"Analyze Health & Decide":{"main":[[{"node":"Route by Action","type":"main","index":0}]]},"Route by Action":{"main":[[{"node":"Build AI Prompt","type":"main","index":0}],[{"node":"Build Runbook Command","type":"main","index":0}],[{"node":"Alert Unreachable","type":"main","index":0}],[{"node":"Log Cooldown Skip","type":"main","index":0}],[{"node":"All Healthy","type":"main","index":0}]]},"Build AI Prompt":{"main":[[{"node":"Send to Claude Code","type":"main","index":0}]]},"Send to Claude Code":{"main":[[{"node":"Parse AI Response","type":"main","index":0}]]},"Parse AI Response":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Build Runbook Command":{"main":[[{"node":"Execute Runbook","type":"main","index":0}]]},"Execute Runbook":{"main":[[{"node":"Parse Runbook Response","type":"main","index":0}]]},"Parse Runbook Response":{"main":[[{"node":"Merge Results","type":"main","index":1}]]},"Alert Unreachable":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]},"Log Cooldown Skip":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]},"All Healthy":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]},"Merge Results":{"main":[[{"node":"Notify Result","type":"main","index":0},{"node":"Log Remediation","type":"main","index":0}]]},"Notify Result":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]},"Log Remediation":{"main":[[{"node":"Log Health Check","type":"main","index":0}]]}},"authors":"Jeff Littell","name":null,"description":null,"autosaved":false,"workflowPublishHistory":[{"createdAt":"2026-01-26T17:36:37.584Z","id":380,"workflowId":"JaTL7b6ka9mH4MuJ","versionId":"e791a888-28f2-4385-a311-c28645fc81cc","event":"activated","userId":"baafff79-4b16-4de2-a858-2c72a40fe7db"}]}}